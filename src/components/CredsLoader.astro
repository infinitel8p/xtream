<script>
	import { Store } from "@tauri-apps/plugin-store";

	const isTauri = typeof window !== "undefined" && !!window.__TAURI__;

	// Single in-memory source of truth for credentials
	/** @type {{host:string,port:string,user:string,pass:string}} */
	let creds = { host: "", port: "", user: "", pass: "" };

	/** Tauri store instance (only when running under Tauri). */
	let store = null;
	if (isTauri) {
		// You can change the filename; it lives in the app data dir.
		store = await Store.load(".xtream.creds.json");
	}

	const setCookie = (name, value, days = 365) => {
		try {
			const date = new Date();
			date.setTime(date.getTime() + days * 864e5);
			document.cookie = `${name}=${encodeURIComponent(
				value
			)}; expires=${date.toUTCString()}; path=/`;
		} catch {}
	};
	const getCookie = (name) => {
		try {
			const match = document.cookie.match(
				new RegExp(
					"(?:^|; )" +
						name.replace(/([.$?*|{}()[\]\\/+^])/g, "\\$1") +
						"=([^;]*)"
				)
			);
			return match ? decodeURIComponent(match[1]) : "";
		} catch {
			return "";
		}
	};

	async function loadCreds() {
		if (isTauri && store) {
			return {
				host: (await store.get("host")) || "",
				port: (await store.get("port")) || "",
				user: (await store.get("user")) || "",
				pass: (await store.get("pass")) || "",
			};
		}
		// Web fallback
		return {
			host: localStorage.getItem("xt_host") || getCookie("xt_host") || "",
			port: localStorage.getItem("xt_port") || getCookie("xt_port") || "",
			user: localStorage.getItem("xt_user") || getCookie("xt_user") || "",
			pass: localStorage.getItem("xt_pass") || getCookie("xt_pass") || "",
		};
	}

	async function saveCreds(next) {
		creds = { ...creds, ...next };
		if (isTauri && store) {
			await store.set("host", creds.host || "");
			await store.set("port", creds.port || "");
			await store.set("user", creds.user || "");
			await store.set("pass", creds.pass || "");
			await store.save();
            console.log("Credentials saved to Tauri store.");
		}
		try {
			setCookie("xt_host", creds.host || "");
			setCookie("xt_port", creds.port || "");
			setCookie("xt_user", creds.user || "");
			setCookie("xt_pass", creds.pass || "");
            console.log("Credentials saved to cookies.");   
			localStorage.setItem("xt_host", creds.host || "");
			localStorage.setItem("xt_port", creds.port || "");
			localStorage.setItem("xt_user", creds.user || "");
			localStorage.setItem("xt_pass", creds.pass || "");
            console.log("Credentials saved to localStorage.");  
		} catch {}
	}

	// Prefill form
	const saveBtn = document.getElementById("saveBtn");
	const $ = (id) => document.getElementById(id);
	const hostEl = $("host");
	const portEl = $("port");
	const userEl = $("user");
	const passEl = $("pass");

	creds = await loadCreds();
	if (hostEl) hostEl.value = creds.host;
	if (portEl) portEl.value = creds.port;
	if (userEl) userEl.value = creds.user;
	if (passEl) passEl.value = creds.pass;

	saveBtn.addEventListener("click", async (e) => {
		e.preventDefault();
		console.log("Saving credsâ€¦");
		await saveCreds({
			host: hostEl.value.trim(),
			port: portEl.value.trim(),
			user: userEl.value.trim(),
			pass: passEl.value.trim(),
		});
	});

    console.log("Credentials loaded:", creds);  
    saveBtn?.click();
    </script>
